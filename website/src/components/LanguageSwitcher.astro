---
import { SUPPORTED_LANGS, type Lang } from '../i18n/config';
import { stripLangPrefix } from '../i18n/urls';

type Props = { lang: Lang; pathname: string; id?: string };
const { lang, pathname, id = 'lang' } = Astro.props;

const rest = stripLangPrefix(pathname);
const options = SUPPORTED_LANGS.map((l) => ({
	lang: l,
	href: `/${l}${rest}`.replaceAll(/\/+/g, '/'),
}));
---

<div class="relative">
	<label class="sr-only" for={id}>Language</label>
	<select
		id={id}
		class="rounded-full border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-ink-600 focus:outline-none focus:ring-2 focus:ring-ink-200 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-ink-300/30"
	>
		{options.map((o) => (
			<option value={o.href} data-lang={o.lang} selected={o.lang === lang}>
				{o.lang.toUpperCase()}
			</option>
		))}
	</select>
</div>

<script is:inline>
	(() => {
		const script = document.currentScript;
		if (!(script instanceof HTMLScriptElement)) return;
		const wrapper = script.previousElementSibling;
		const select = wrapper?.querySelector('select');
		if (!(select instanceof HTMLSelectElement)) return;

		select.addEventListener('change', () => {
			const selected = select.selectedOptions?.[0];
			const lang = selected?.dataset?.lang;
			if (lang) {
				try {
					localStorage.setItem('pelvisana_lang', lang);
					localStorage.setItem('pelvisana_lang_mode', 'manual');
				} catch {}
			}
			location.href = select.value;
		});
	})();
</script>
